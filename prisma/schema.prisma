// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}



model User {
  id             String  @id @default(uuid())
  email          String  @unique
  name           String
  role           String  // ADMIN, AGENCY, INTERNAL, MANAGER
  organizationId String? // Legacy/Generic
  agencyId       String?
  agency         Agency? @relation(fields: [agencyId], references: [id])
  cases          Case[]
  passwordHash   String? // Added for local auth
}

model Agency {
  id        String   @id @default(uuid())
  name      String
  status    String   @default("ACTIVE") // ACTIVE, INACTIVE
  capacity  Int      @default(5)
  region    String   @default("NA")
  tier      String   @default("STANDARD") // STANDARD, PREFERRED
  score     Float    @default(0)          // Current live score
  deletedAt DateTime?

  users       User[]
  performance AgencyPerformance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AgencyPerformance {
  id           String @id @default(uuid())
  agencyId     String
  agency       Agency @relation(fields: [agencyId], references: [id])
  month        String // YYYY-MM
  recoveryRate Float
  slaAdherence Float
  avgDSO       Float
  
  createdAt    DateTime @default(now())

  @@unique([agencyId, month], name: "agency_month_unique")
}

model Invoice {
  id          String   @id @default(uuid())
  invoiceNumber String @unique
  amount      Float
  currency    String   @default("USD")
  dueDate     DateTime
  customerID  String
  customerName String
  region      String
  status      String   // OPEN, PAID, OVERDUE, DISPUTE
  
  case        Case?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Case {
  id                  String   @id @default(uuid())
  invoiceId           String   @unique
  invoice             Invoice  @relation(fields: [invoiceId], references: [id])
  
  aiScore             Float    // 0-100
  recoveryProbability Float    // 0-1
  priority            String   // HIGH, MEDIUM, LOW
  
  status              String   // NEW, ASSIGNED, IN_PROGRESS, PTP, DISPUTE, PAID, UNREACHABLE, CLOSED
  assignedToId        String?
  assignedTo          User?    @relation(fields: [assignedToId], references: [id])
  assignedAt          DateTime? // Added for precise SLA tracking
  
  currentSLAStatus    String   // ACTIVE, BREACHED, PAUSED, COMPLETED
  slaBreachTime       DateTime?
  
  auditLogs           AuditLog[]
  slaRecords          SLA[]
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model AuditLog {
  id        String   @id @default(uuid())
  caseId    String?  // Optional to allow system/agency logs
  case      Case?    @relation(fields: [caseId], references: [id]) // Optional
  
  entityType String  @default("CASE") // CASE, AGENCY, SYSTEM
  actorId   String
  actorRole String?  // ADMIN, AGENCY, SYSTEM
  action    String   // NOTE, STATUS_CHANGE, ASSIGN, UPLOAD, PTP, DISPUTE
  details   String
  timestamp DateTime @default(now())
}

model SLA {
  id        String   @id @default(uuid())
  caseId    String
  case      Case     @relation(fields: [caseId], references: [id])
  
  stage     String   // FIRST_CONTACT, FOLLOW_UP, RESOLUTION
  status    String   // PENDING, ACTIVE, BREACHED, MET
  startTime DateTime @default(now())
  endTime   DateTime?
  dueTime   DateTime
}
